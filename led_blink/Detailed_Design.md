# 詳細設計書

## プロジェクト情報
- **プロジェクト名**: Arduino UNO R4 MINIMA - 20x4 I2C LCD Display Demo
- **バージョン**: 1.0
- **作成日**: 2025-11-14
- **対象ボード**: Arduino UNO R4 MINIMA
- **開発環境**: Arduino CLI 1.3.1

---

## 1. システム概要

### 1.1 目的
Arduino UNO R4 MINIMAを使用して、SunFounder 20x4 I2C LCDディスプレイにカウンタを表示するデモプログラム。

### 1.2 機能概要
- LCDディスプレイに起動メッセージを表示
- 1秒ごとにカウンタをインクリメント
- カウンタ値をLCD 4行目に表示

---

## 2. ハードウェア仕様

### 2.1 使用部品
| 部品名 | 型番/仕様 | 数量 | 用途 |
|--------|-----------|------|------|
| マイコンボード | Arduino UNO R4 MINIMA | 1 | メインコントローラ |
| LCDディスプレイ | SunFounder 20x4 I2C LCD | 1 | 情報表示 |
| USBケーブル | USB Type-C | 1 | 電源供給・プログラム書き込み |
| ジャンパーワイヤ | メス-メス | 4 | I2C接続 |

### 2.2 配線図
```
Arduino UNO R4 MINIMA          SunFounder 20x4 I2C LCD
┌─────────────────┐           ┌──────────────────┐
│                 │           │                  │
│  5V     ────────┼───────────┤ VCC              │
│  GND    ────────┼───────────┤ GND              │
│  SDA(A4)────────┼───────────┤ SDA              │
│  SCL(A5)────────┼───────────┤ SCL              │
│                 │           │                  │
└─────────────────┘           └──────────────────┘
```

### 2.3 I2C仕様
- **I2Cアドレス**: 0x27 (または0x3F)
- **通信速度**: 標準モード (100kbps)
- **プルアップ抵抗**: LCD基板上に実装済み

---

## 3. ソフトウェア仕様

### 3.1 ファイル構成
```
led_blink/
├── led_blink.ino          # メインプログラム
├── led_blink.h            # ヘッダファイル
└── README.md              # プロジェクト説明書
```

### 3.2 使用ライブラリ
| ライブラリ名 | バージョン | 用途 |
|-------------|-----------|------|
| Arduino.h | - | Arduino標準ライブラリ |
| LiquidCrystal_I2C | 2.0.0 | I2C LCD制御 |
| Wire | - | I2C通信 |

### 3.3 定数定義
| 定数名 | 型 | 値 | 説明 |
|--------|----|----|------|
| LED_PIN | uint8_t | LED_BUILTIN | LED出力ピン |
| DELAY_TIME_MS | uint16_t | 50 | 遅延時間(未使用) |
| LCD_I2C_ADDR | uint8_t | 0x27 | LCDのI2Cアドレス |
| LCD_COLS | uint8_t | 20 | LCD列数 |
| LCD_ROWS | uint8_t | 4 | LCD行数 |

### 3.4 グローバル変数
| 変数名 | 型 | 初期値 | 説明 |
|--------|----|----|------|
| lcd | LiquidCrystal_I2C | - | LCDオブジェクト |
| loopCounter | uint32_t | 0 | ループカウンタ |

---

## 4. 関数仕様

### 4.1 setup()
**概要**: 初期化処理

**処理フロー**:
1. LEDピンを出力モードに設定
2. LCD初期化 (`lcd.init()`)
3. バックライトON (`lcd.backlight()`)
4. 画面クリア (`lcd.clear()`)
5. 起動メッセージ表示
   - 1行目: "Arduino UNO R4"
   - 2行目: "LED Blink 100ms"
   - 3行目: "20x4 I2C LCD"
   - 4行目: "Status: Running"

**実行時間**: 約200ms

### 4.2 loop()
**概要**: メインループ処理

**処理フロー**:
1. ループカウンタをインクリメント
2. LCDカーソルを4行目先頭に移動
3. "Count: " を表示
4. カウンタ値を表示
5. 余分な文字をクリア (8文字分の空白)
6. 1000ms待機

**実行周期**: 1秒

---

## 5. LCD表示仕様

### 5.1 表示レイアウト
```
┌────────────────────┐
│Arduino UNO R4      │  1行目
│LED Blink 100ms     │  2行目
│20x4 I2C LCD        │  3行目
│Count: 123          │  4行目 (カウンタ表示)
└────────────────────┘
```

### 5.2 表示文字列仕様
| 行 | 列 | 表示内容 | 更新頻度 |
|----|-------|---------|---------|
| 1 | 0-14 | "Arduino UNO R4" | 起動時のみ |
| 2 | 0-15 | "LED Blink 100ms" | 起動時のみ |
| 3 | 0-12 | "20x4 I2C LCD" | 起動時のみ |
| 4 | 0-6 | "Count: " | 起動時のみ |
| 4 | 7-19 | カウンタ値 | 1秒ごと |

---

## 6. メモリ使用量

### 6.1 フラッシュメモリ
- **使用量**: 45,468バイト
- **最大容量**: 262,144バイト
- **使用率**: 17%

### 6.2 RAM
- **グローバル変数**: 5,120バイト
- **ローカル変数**: 27,648バイト (利用可能)
- **最大容量**: 32,768バイト
- **使用率**: 15%

---

## 7. ビルド・デプロイ情報

### 7.1 コンパイル
**コマンド**:
```powershell
arduino-cli compile --fqbn arduino:renesas_uno:minima led_blink.ino
```

**実行時間**: 約1,806ms

### 7.2 アップロード
**コマンド**:
```powershell
arduino-cli upload -p COM3 --fqbn arduino:renesas_uno:minima led_blink.ino
```

**実行時間**: 約15,498ms

**書き込みツール**: dfu-util 0.11-arduino4

---

## 8. MISRA-C準拠

本プログラムは以下のMISRA-Cルールに準拠しています:

| ルール | 内容 | 対応状況 |
|--------|------|---------|
| Rule 2.3, 2.5 | マジックナンバーを定数として定義 | ✓ |
| Rule 8.1 | 関数プロトタイプ宣言 | ✓ |
| Rule 8.2 | 関数パラメータにvoid明示 | ✓ |
| Rule 8.4 | static constで内部リンケージ定数定義 | ✓ |

---

## 9. コーディング規約

### 9.1 命名規則
- **定数**: UPPER_SNAKE_CASE (例: LCD_I2C_ADDR)
- **変数**: camelCase (例: loopCounter)
- **関数**: camelCase (例: setup, loop)

### 9.2 フォーマット規則
- **括弧スタイル**: Allman (BSD/ANSI)
- **インデント**: 2スペース
- **行コメント開始位置**: 80桁目
- **関数名とかっこの間**: 1スペース
- **トークン間**: 適切なスペース挿入
- **タブ**: 使用禁止 (スペースに展開)

---

## 10. テスト仕様

### 10.1 動作確認項目
| No. | 項目 | 確認内容 | 期待結果 |
|-----|------|---------|---------|
| 1 | 起動確認 | 電源投入 | LCDに起動メッセージ表示 |
| 2 | カウンタ動作 | 1秒待機 | カウンタが1増加 |
| 3 | LCD表示 | 目視確認 | 文字が正しく表示される |
| 4 | I2C通信 | I2Cスキャナで確認 | 0x27でデバイス検出 |

### 10.2 異常系テスト
| No. | 項目 | 試験方法 | 期待結果 |
|-----|------|---------|---------|
| 1 | LCD未接続 | LCD未接続で起動 | プログラムは動作するがLCD表示なし |
| 2 | I2Cアドレス不一致 | アドレス0x3Fに変更 | LCD表示されない |

---

## 11. トラブルシューティング

### 11.1 LCDに何も表示されない
**原因と対処**:
1. I2C配線確認 (SDA, SCL, VCC, GND)
2. I2Cアドレス確認 (0x27 ⇔ 0x3F)
3. バックライト調整 (LCD背面のポテンショメータ)
4. I2Cスキャナで接続確認

### 11.2 文字が化ける
**原因と対処**:
1. LCD初期化失敗 → リセットボタン押下
2. 電源電圧不足 → USB電源確認

---

## 12. 今後の拡張

### 12.1 機能追加案
- [ ] 温湿度センサー(DHT22)データ表示
- [ ] リアルタイムクロック(RTC)表示
- [ ] ボタン入力によるメニュー切り替え
- [ ] グラフ表示機能

### 12.2 性能改善案
- [ ] LCD更新頻度の最適化
- [ ] 低消費電力モード実装

---

## 13. 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|--------|
| 1.0 | 2025-11-14 | 初版作成 | - |

---

## 14. 参考資料

- Arduino UNO R4 MINIMA公式ドキュメント
- LiquidCrystal_I2C ライブラリ仕様書
- SunFounder 20x4 LCD データシート
- MISRA-C:2012 ガイドライン
