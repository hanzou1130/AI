<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="1600" viewBox="0 0 1000 1600">
  <style>
    .box { fill: #fff; stroke: #0b3b75; stroke-width:2px; rx:6; }
    .alt { fill:#f7fbff; }
    .text { font-family: Arial, Helvetica, sans-serif; font-size:12px; fill:#111; }
    .title { font-size:16px; font-weight:700; fill:#0b3b75; }
    .arrow { stroke:#333; stroke-width:2px; fill:none; marker-end: url(#arrowhead); }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
  </defs>
  <text x="500" y="30" text-anchor="middle" class="title">Detailed Startup Flow (細分化)</text>

  <g transform="translate(40,60)">
    <!-- Reset -->
    <rect x="340" y="10" width="300" height="28" class="box"/>
    <text x="500" y="24" text-anchor="middle" dominant-baseline="middle" class="text">Reset Vector (_RESET)</text>
    <path class="arrow" d="M500 54 L500 100" />

    <!-- start -->
    <rect x="340" y="100" width="300" height="28" class="box alt"/>
    <text x="500" y="114" text-anchor="middle" dominant-baseline="middle" class="text">_start (cstartup.asm) — 初期化エントリ</text>
    <path class="arrow" d="M500 156 L500 200" />

    <!-- Disable interrupts -->
    <rect x="340" y="200" width="300" height="28" class="box"/>
    <text x="500" y="214" text-anchor="middle" dominant-baseline="middle" class="text">Disable interrupts (di)</text>
    <path class="arrow" d="M500 248 L500 290" />

    <!-- SP Init -->
    <rect x="340" y="290" width="300" height="28" class="box alt"/>
    <text x="500" y="304" text-anchor="middle" dominant-baseline="middle" class="text">Initialize SP = SP_INIT (0xFEE28000)</text>
    <text x="500" y="342" text-anchor="middle" class="text" style="font-size:12px;">(hi/lo movea を使用)</text>
    <path class="arrow" d="M500 354 L500 400" />

    <!-- BSS clear -->
    <rect x="340" y="400" width="300" height="28" class="box"/>
    <text x="500" y="414" text-anchor="middle" dominant-baseline="middle" class="text">Clear BSS: for (p=__sbss; p<__ebss; p+=4) *p = 0</text>
    <text x="500" y="452" text-anchor="middle" class="text" style="font-size:12px;">r6=__sbss, r7=__ebss, r0=0, st.w r0,0[r6]; add 4,r6</text>
    <path class="arrow" d="M500 472 L500 520" />

    <!-- Data copy -->
    <rect x="340" y="520" width="300" height="28" class="box alt"/>
    <text x="500" y="534" text-anchor="middle" dominant-baseline="middle" class="text">Copy .data: for (dst=__sdata; dst<__edata; dst+=4) *dst = *src++</text>
    <text x="500" y="570" text-anchor="middle" class="text" style="font-size:12px;">r6=__sdata_rom(src), r7=__sdata(dst), r8=__edata, ld.w 0[r6],r9; st.w r9,0[r7]</text>
    <path class="arrow" d="M500 608 L500 660" />

    <!-- Optional: data checksum/verify (annotated) -->
    <rect x="340" y="660" width="300" height="28" class="box"/>
    <text x="500" y="674" text-anchor="middle" dominant-baseline="middle" class="text">(Optional) Verify data copy / checksum / protect registers</text>
    <path class="arrow" d="M500 724 L500 780" />

    <!-- SystemInit call -->
    <rect x="340" y="780" width="300" height="28" class="box alt"/>
    <text x="500" y="794" text-anchor="middle" dominant-baseline="middle" class="text">Call SystemInit()</text>
    <path class="arrow" d="M500 834 L500 880" />

    <!-- Enable interrupts -->
    <rect x="340" y="880" width="300" height="28" class="box"/>
    <text x="500" y="894" text-anchor="middle" dominant-baseline="middle" class="text">Enable interrupts (ei)</text>
    <path class="arrow" d="M500 934 L500 980" />

    <!-- Jump to main -->
    <rect x="340" y="980" width="300" height="28" class="box alt"/>
    <text x="500" y="994" text-anchor="middle" dominant-baseline="middle" class="text">Jump to main() (jmp [addr])</text>
    <path class="arrow" d="M500 1034 L500 1080" />

    <!-- main -->
    <rect x="340" y="1080" width="300" height="28" class="box"/>
    <text x="500" y="1094" text-anchor="middle" dominant-baseline="middle" class="text">main() — アプリケーション開始</text>
    <text x="500" y="1136" text-anchor="middle" class="text" style="font-size:12px;">(GPIO 初期化 → ループ → LED toggle 等)</text>
  </g>

  <!-- Side note: Exception table -->
  <text x="500" y="1500" text-anchor="middle" class="text">注: 例外ベクタは `__exception_table` に配置。必要に応じてハンドラを割当ててください。</text>
</svg>