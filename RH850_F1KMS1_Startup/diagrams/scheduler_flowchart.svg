<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 1200">
  <!-- Title -->
  <text x="400" y="30" text-anchor="middle" font-size="20" font-weight="bold" fill="#333">スケジューラ動作フロー</text>
  
  <!-- Start -->
  <ellipse cx="400" cy="80" rx="60" ry="30" fill="#4CAF50" stroke="#333" stroke-width="2"/>
  <text x="400" y="88" text-anchor="middle" font-size="14" fill="white">開始</text>
  
  <!-- Arrow -->
  <line x1="400" y1="110" x2="400" y2="140" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Scheduler_Init() -->
  <rect x="300" y="140" width="200" height="60" rx="5" fill="#2196F3" stroke="#333" stroke-width="2"/>
  <text x="400" y="165" text-anchor="middle" font-size="14" fill="white">Scheduler_Init()</text>
  <text x="400" y="185" text-anchor="middle" font-size="12" fill="white">タスクテーブルクリア</text>
  
  <!-- Arrow -->
  <line x1="400" y1="200" x2="400" y2="230" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- AddTask #1 -->
  <rect x="300" y="230" width="200" height="60" rx="5" fill="#2196F3" stroke="#333" stroke-width="2"/>
  <text x="400" y="255" text-anchor="middle" font-size="14" fill="white">Scheduler_AddTask()</text>
  <text x="400" y="275" text-anchor="middle" font-size="12" fill="white">LED Task, 500ms</text>
  
  <!-- Arrow -->
  <line x1="400" y1="290" x2="400" y2="320" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- AddTask #2 -->
  <rect x="300" y="320" width="200" height="60" rx="5" fill="#2196F3" stroke="#333" stroke-width="2"/>
  <text x="400" y="345" text-anchor="middle" font-size="14" fill="white">Scheduler_AddTask()</text>
  <text x="400" y="365" text-anchor="middle" font-size="12" fill="white">Counter Task, 500ms</text>
  
  <!-- Arrow -->
  <line x1="400" y1="380" x2="400" y2="410" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Scheduler_Run() -->
  <rect x="300" y="410" width="200" height="60" rx="5" fill="#FF9800" stroke="#333" stroke-width="2"/>
  <text x="400" y="435" text-anchor="middle" font-size="14" fill="white">Scheduler_Run()</text>
  <text x="400" y="455" text-anchor="middle" font-size="12" fill="white">メインループ開始</text>
  
  <!-- Arrow -->
  <line x1="400" y1="470" x2="400" y2="500" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Loop Start -->
  <ellipse cx="400" cy="530" rx="80" ry="30" fill="#FFC107" stroke="#333" stroke-width="2"/>
  <text x="400" y="538" text-anchor="middle" font-size="14" fill="#333">ループ開始</text>
  
  <!-- Arrow -->
  <line x1="400" y1="560" x2="400" y2="590" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Get current time -->
  <rect x="300" y="590" width="200" height="50" rx="5" fill="#03A9F4" stroke="#333" stroke-width="2"/>
  <text x="400" y="620" text-anchor="middle" font-size="13" fill="white">now = s_ticks_ms</text>
  
  <!-- Arrow -->
  <line x1="400" y1="640" x2="400" y2="670" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- For each task -->
  <rect x="280" y="670" width="240" height="50" rx="5" fill="#9C27B0" stroke="#333" stroke-width="2"/>
  <text x="400" y="700" text-anchor="middle" font-size="13" fill="white">各タスクをスキャン (i=0..7)</text>
  
  <!-- Arrow -->
  <line x1="400" y1="720" x2="400" y2="750" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Task used? -->
  <path d="M 400 750 L 480 800 L 400 850 L 320 800 Z" fill="#E91E63" stroke="#333" stroke-width="2"/>
  <text x="400" y="808" text-anchor="middle" font-size="13" fill="white">タスク使用中?</text>
  
  <!-- No branch -->
  <line x1="480" y1="800" x2="550" y2="800" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="520" y="795" text-anchor="middle" font-size="12" fill="#333">NO</text>
  <line x1="550" y1="800" x2="550" y2="700" stroke="#333" stroke-width="2"/>
  <line x1="550" y1="700" x2="520" y2="700" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Yes branch -->
  <line x1="400" y1="850" x2="400" y2="880" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="360" y="870" text-anchor="middle" font-size="12" fill="#333">YES</text>
  
  <!-- Time elapsed check -->
  <path d="M 400 880 L 480 930 L 400 980 L 320 930 Z" fill="#E91E63" stroke="#333" stroke-width="2"/>
  <text x="400" y="928" text-anchor="middle" font-size="12" fill="white">経過時間 >=</text>
  <text x="400" y="943" text-anchor="middle" font-size="12" fill="white">周期?</text>
  
  <!-- No branch -->
  <line x1="480" y1="930" x2="550" y2="930" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="520" y="925" text-anchor="middle" font-size="12" fill="#333">NO</text>
  <line x1="550" y1="930" x2="550" y2="700" stroke="#333" stroke-width="2"/>
  
  <!-- Yes branch -->
  <line x1="400" y1="980" x2="400" y2="1010" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="360" y="1000" text-anchor="middle" font-size="12" fill="#333">YES</text>
  
  <!-- Execute task -->
  <rect x="300" y="1010" width="200" height="50" rx="5" fill="#4CAF50" stroke="#333" stroke-width="2"/>
  <text x="400" y="1040" text-anchor="middle" font-size="13" fill="white">タスク実行 func()</text>
  
  <!-- Arrow -->
  <line x1="400" y1="1060" x2="400" y2="1090" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Update last_run -->
  <rect x="300" y="1090" width="200" height="50" rx="5" fill="#03A9F4" stroke="#333" stroke-width="2"/>
  <text x="400" y="1120" text-anchor="middle" font-size="13" fill="white">last_run_ms = now</text>
  
  <!-- Arrow back to loop -->
  <line x1="300" y1="1115" x2="250" y2="1115" stroke="#333" stroke-width="2"/>
  <line x1="250" y1="1115" x2="250" y2="700" stroke="#333" stroke-width="2"/>
  <line x1="250" y1="700" x2="280" y2="700" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Note: Interrupt -->
  <rect x="600" y="500" width="180" height="80" rx="5" fill="#FFF9C4" stroke="#FF9800" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="690" y="520" text-anchor="middle" font-size="12" font-weight="bold" fill="#333">【並列動作】</text>
  <text x="690" y="540" text-anchor="middle" font-size="11" fill="#333">1msタイマー割り込み</text>
  <text x="690" y="555" text-anchor="middle" font-size="11" fill="#333">↓</text>
  <text x="690" y="570" text-anchor="middle" font-size="11" fill="#333">Scheduler_TickISR()</text>
  
  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#333"/>
    </marker>
  </defs>
</svg>
