<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RH850/F1KM-S1　詳細設計書</title>
  <style>
    :root {
      --bg: #fbfdff;
      --surface: #ffffff;
      --primary: #2563eb; /* blue */
      --accent: #06b6d4;  /* teal */
      --success: #10b981; /* green */
      --danger: #ef4444;  /* red */
      --muted: #eef9fb;
      --text: #0b2b3a;
    }
    body { font-family: Arial, Helvetica, sans-serif; line-height: 1.6; margin: 20px; color: var(--text); background: linear-gradient(180deg,#f8fbff 0%,var(--bg) 100%); }
    h1 { color: #fff; margin:0; padding:18px; font-size:22px; }
    h2,h3 { color: var(--primary); }
    .doc-banner { background: linear-gradient(90deg,var(--primary),var(--accent)); border-radius:8px; padding:6px 12px; margin-bottom:18px; display:inline-block }
    .doc-sub { color: #e6f2ff; font-size:13px; margin-top:6px }
    pre { background: #001422; color: #e6f7ff; padding: 12px; overflow: auto; border-radius:6px }
    table { border-collapse: collapse; width: 100%; background: var(--surface); border-radius:6px; overflow:hidden }
    th { background: linear-gradient(90deg,#e6f3ff,#eef9ff); color: var(--primary); padding:8px; text-align:left }
    td { border-top: 1px solid #eef3f8; padding:8px }
    tbody tr:nth-child(odd) td { background: #fbfeff }
    .legend { display:flex; gap:12px; align-items:center; margin:12px 0 }
    .legend .item { display:flex; gap:8px; align-items:center }
    .sw { width:18px; height:14px; border-radius:4px; display:inline-block }
    a.repo { color:var(--accent) }
  </style>
</head>
<body>
  <div class="doc-banner">
    <h1>RH850/F1KM-S1　詳細設計書</h1>
    <div class="doc-sub">Startup, SystemInit, フロー図 と リファレンス</div>
  </div>
  <h2>概要</h2>
  <p>この文書は RH850/F1KM-S1 向けに作成したスタートアップ一式（アセンブリ、リンカスクリプト、システム初期化、サンプルアプリ）についての詳細設計を示します。</p>
  <h2>ファイル一覧</h2>
  <ul>
    <li><code>src/cstartup.asm</code> : スタートアップ（リセットベクタ、BSSクリア、データコピー、SystemInit 呼び出し）</li>
    <li><code>linker_script.ld</code>  : メモリマップとセクション割当</li>
    <li><code>src/system_rh850.c</code> : システム初期化（MainOSC/PLL/クロック分周、割り込み初期化）</li>
    <li><code>inc/system_rh850.h</code> : システム初期化のヘッダ</li>
    <li><code>inc/rh850_regs.h</code>   : レジスタ定義</li>
    <li><code>src/main.c</code>        : サンプルアプリ（LED点滅）</li>
  </ul>
  <h2>メモリマップ</h2>
  <table>
    <thead>
      <tr><th>領域</th><th>開始アドレス</th><th>サイズ</th><th>用途</th></tr>
    </thead>
    <tbody>
      <tr><td>Code Flash</td><td>0x00000000</td><td>2MB</td><td>プログラムコード</td></tr>
      <tr><td>Data Flash</td><td>0x01000000</td><td>64KB</td><td>データ保存</td></tr>
      <tr><td>RAM</td><td>0xFEDE8000</td><td>256KB</td><td>データ・スタック</td></tr>
    </tbody>
  </table>
  <h2>起動シーケンス</h2>
  <ol>
    <li>リセットベクタへジャンプ（<code>_RESET</code>）</li>
    <li><code>cstartup.asm::_start</code> 実行（割り込み無効化、SP 初期化、BSS クリア、データコピー、<code>SystemInit()</code> 呼び出し、割り込み有効化、<code>main()</code> へ移行）</li>
  </ol>
  <h2>フローチャート</h2>
  <p>ブート・スタートアップのフロー図（下図参照）</p>
  <div class="legend" aria-hidden="true">
    <div class="item"><span class="sw" style="background:#ffffff; border:2px solid #0b84ff"></span><span>標準ステップ</span></div>
    <div class="item"><span class="sw" style="background:#e6fbf8; border:2px solid #06b6d4"></span><span>補助/代替ステップ</span></div>
    <div class="item"><span class="sw" style="background:#fff0f0; border:2px solid #ff6b6b"></span><span>失敗 / フェイルパス</span></div>
    <div class="item"><span class="sw" style="background:#f4f8ff; border:2px solid #2563eb"></span><span>情報 / 注記</span></div>
  </div>
  <svg xmlns="http://www.w3.org/2000/svg" width="900" height="1200" viewBox="0 0 900 1200" style="max-width:100%;border:1px solid #ddd;padding:8px;background:#fff;">
    <!-- inlined from diagrams/startup_flowchart.svg (compact boxes) -->
    <style>
      .box { fill: #ffffff; stroke:#0b84ff; stroke-width:1.6px; rx:6; }
      .box.alt { fill:#e6fbf8; stroke:#06b6d4 }
      .text { font-family: Helvetica, Arial, sans-serif; font-size:11px; fill:#07263c; }
      .title { font-size:16px; font-weight:700; fill:#074b9c; }
      .arrow { stroke:#0b84ff; stroke-width:1.6px; stroke-linecap:round; fill:none; marker-end: url(#arrowhead); }
    </style>
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
      </marker>
    </defs>
    <text x="450" y="36" text-anchor="middle" class="title">RH850/F1KM-S1 Startup Flowchart</text>
    <g transform="translate(150,70)">
      <rect x="200" y="30" width="300" height="28" class="box"/>
      <text x="350" y="44" text-anchor="middle" dominant-baseline="middle" class="text">Reset Vector (_RESET)</text>
      <path class="arrow" d="M350 66 L350 112" />
      <rect x="200" y="120" width="300" height="28" class="box alt"/>
      <text x="350" y="134" text-anchor="middle" dominant-baseline="middle" class="text">_start (cstartup.asm)</text>
      <path class="arrow" d="M350 156 L350 202" />
      <rect x="200" y="210" width="300" height="28" class="box"/>
      <text x="350" y="224" text-anchor="middle" dominant-baseline="middle" class="text">Disable interrupts (di)</text>
      <path class="arrow" d="M350 246 L350 292" />
      <rect x="200" y="300" width="300" height="28" class="box alt"/>
      <text x="350" y="314" text-anchor="middle" dominant-baseline="middle" class="text">Initialize SP (SP_INIT)</text>
      <path class="arrow" d="M350 336 L350 382" />
      <rect x="200" y="390" width="300" height="28" class="box"/>
      <text x="350" y="404" text-anchor="middle" dominant-baseline="middle" class="text">Clear BSS (__sbss → __ebss)</text>
      <path class="arrow" d="M350 426 L350 472" />
      <rect x="200" y="480" width="300" height="28" class="box alt"/>
      <text x="350" y="494" text-anchor="middle" dominant-baseline="middle" class="text">Copy initialized data (ROM → RAM)</text>
      <path class="arrow" d="M350 516 L350 562" />
      <rect x="200" y="570" width="300" height="28" class="box"/>
      <text x="350" y="584" text-anchor="middle" dominant-baseline="middle" class="text">Call SystemInit()</text>
      <path class="arrow" d="M350 606 L350 652" />
      <rect x="200" y="660" width="300" height="28" class="box alt"/>
      <text x="350" y="674" text-anchor="middle" dominant-baseline="middle" class="text">Enable interrupts (ei)</text>
      <path class="arrow" d="M350 696 L350 742" />
      <rect x="200" y="750" width="300" height="28" class="box"/>
      <text x="350" y="764" text-anchor="middle" dominant-baseline="middle" class="text">Jump to main()</text>
      <path class="arrow" d="M350 786 L350 832" />
      <rect x="200" y="840" width="300" height="28" class="box alt"/>
      <text x="350" y="854" text-anchor="middle" dominant-baseline="middle" class="text">main() - Application</text>
    </g>
    <text x="450" y="1160" text-anchor="middle" class="text">図: ブートからアプリケーション開始までの主要ステップ</text>
  </svg>
  <h3>Startup Flow with Error Branches（エラー分岐）</h3>
  <!-- inlined from diagrams/startup_flowchart_with_errors.svg -->
  <svg xmlns="http://www.w3.org/2000/svg" width="1000" height="1400" viewBox="0 0 1000 1400" style="max-width:100%;border:1px solid #ddd;padding:8px;background:#fff;">
    <style>
      .box { fill:#fff; stroke:#0b3b75; stroke-width:2px; rx:6 }
      .alt { fill:#f7fbff }
      .fail { fill:#fff5f5; stroke:#c92a2a; stroke-width:2px }
      .text { font-family: Arial, Helvetica, sans-serif; font-size:12px; fill:#111 }
      .title { font-size:16px; font-weight:700; fill:#0b3b75 }
      .arrow { stroke:#333; stroke-width:2px; fill:none; marker-end:url(#arrow) }
    </style>
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
      </marker>
    </defs>
    <text x="500" y="30" text-anchor="middle" class="title">Startup Flow with Error Branches</text>
    <g transform="translate(40,60)">
      <rect x="340" y="10" width="300" height="28" class="box"/>
      <text x="490" y="24" text-anchor="middle" dominant-baseline="middle" class="text">Reset Vector (_RESET)</text>
      <path class="arrow" d="M490 60 L490 110" />

      <rect x="340" y="110" width="300" height="28" class="alt"/>
      <text x="490" y="124" text-anchor="middle" dominant-baseline="middle" class="text">_start (cstartup.asm)</text>
      <path class="arrow" d="M490 170 L490 210" />

      <rect x="340" y="210" width="300" height="28" class="box"/>
      <text x="490" y="224" text-anchor="middle" dominant-baseline="middle" class="text">Disable interrupts; Init SP</text>
      <path class="arrow" d="M490 268 L490 310" />

      <rect x="340" y="310" width="300" height="28" class="alt"/>
      <text x="490" y="324" text-anchor="middle" dominant-baseline="middle" class="text">BSS Clear; Data copy (ROM→RAM)</text>
      <path class="arrow" d="M490 378 L490 430" />

      <rect x="340" y="430" width="300" height="28" class="box"/>
      <text x="490" y="444" text-anchor="middle" dominant-baseline="middle" class="text">Optional: Verify data (CRC)</text>
      <path class="arrow" d="M490 498 L490 540" />

      <rect x="340" y="540" width="300" height="28" class="alt"/>
      <text x="490" y="554" text-anchor="middle" dominant-baseline="middle" class="text">Verify OK</text>
      <rect x="340" y="600" width="300" height="28" class="fail"/>
      <text x="490" y="614" text-anchor="middle" dominant-baseline="middle" class="text">Verify FAIL → bootloader / restore</text>

      <path class="arrow" d="M260 614 L340 614" />
      <path class="arrow" d="M640 614 L640 660" />
      <path class="arrow" d="M640 660 L490 700" />

      <rect x="340" y="630" width="300" height="28" class="box"/>
      <text x="490" y="644" text-anchor="middle" dominant-baseline="middle" class="text">Call SystemInit()</text>
      <path class="arrow" d="M490 696 L490 740" />

      <rect x="340" y="740" width="300" height="28" class="box"/>
      <text x="490" y="754" text-anchor="middle" dominant-baseline="middle" class="text">SystemInit OK</text>
      <rect x="340" y="800" width="300" height="28" class="fail"/>
      <text x="490" y="814" text-anchor="middle" dominant-baseline="middle" class="text">SystemInit FAIL → Safe Mode / Halt</text>

      <path class="arrow" d="M300 814 L340 814" />
      <path class="arrow" d="M640 814 L640 840" />

      <rect x="340" y="840" width="300" height="28" class="alt"/>
      <text x="490" y="854" text-anchor="middle" dominant-baseline="middle" class="text">Enable interrupts; Jump to main()</text>
      <path class="arrow" d="M490 896 L490 940" />

      <rect x="340" y="940" width="300" height="28" class="box"/>
      <text x="490" y="954" text-anchor="middle" dominant-baseline="middle" class="text">main() — Application (正常動作)</text>

      <rect x="340" y="1040" width="300" height="28" class="fail"/>
      <text x="490" y="1054" text-anchor="middle" dominant-baseline="middle" class="text">Safe Mode / Error LED / Wait for host update</text>
    </g>

    <text x="500" y="1360" text-anchor="middle" class="text">注: フェイルパスは製品要件に合わせて設計してください。例: 再試行回数・フェイル時の挙動・ログ出力方法など。</text>
  </svg>
  <h3>詳細フロー図</h3>
  <p>起動メインフロー（細分化）</p>
  <!-- inline Detailed Startup Flow SVG -->
  <svg xmlns="http://www.w3.org/2000/svg" width="1000" height="1600" viewBox="0 0 1000 1600" style="max-width:100%;border:1px solid #ddd;padding:8px;background:#fff;">
    <!-- inlined from diagrams/startup_flowchart_detailed.svg (compact boxes) -->
    <style>
      .box { fill: #ffffff; stroke:#7c3aed; stroke-width:1.6px; rx:6; }
      .alt { fill:#f3efff; }
      .text { font-family: Arial, Helvetica, sans-serif; font-size:11px; fill:#07263c; }
      .title { font-size:16px; font-weight:700; fill:#6d28d9; }
      .arrow { stroke:#7c3aed; stroke-width:1.6px; stroke-linecap:round; fill:none; marker-end: url(#arrowhead); }
    </style>
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
      </marker>
    </defs>
    <text x="500" y="30" text-anchor="middle" class="title">Detailed Startup Flow (細分化)</text>
    <g transform="translate(40,60)">
      <rect x="340" y="10" width="300" height="28" class="box"/>
      <text x="500" y="24" text-anchor="middle" dominant-baseline="middle" class="text">Reset Vector (_RESET)</text>
      <path class="arrow" d="M500 44 L500 104" />
      <rect x="340" y="100" width="300" height="28" class="box alt"/>
      <text x="500" y="114" text-anchor="middle" dominant-baseline="middle" class="text">_start (cstartup.asm) — 初期化エントリ</text>
      <path class="arrow" d="M500 134 L500 194" />
      <rect x="340" y="200" width="300" height="28" class="box"/>
      <text x="500" y="214" text-anchor="middle" dominant-baseline="middle" class="text">Disable interrupts (di)</text>
      <path class="arrow" d="M500 234 L500 294" />
      <rect x="340" y="290" width="300" height="28" class="box alt"/>
      <text x="500" y="304" text-anchor="middle" dominant-baseline="middle" class="text">Initialize SP = SP_INIT (0xFEE28000)</text>
      <text x="500" y="322" text-anchor="middle" class="text" style="font-size:11px;">(hi/lo movea を使用)</text>
      <path class="arrow" d="M500 334 L500 394" />
      <rect x="340" y="400" width="300" height="28" class="box"/>
      <text x="500" y="414" text-anchor="middle" dominant-baseline="middle" class="text">Clear BSS: for (p=__sbss; p<__ebss; p+=4) *p = 0</text>
      <text x="500" y="434" text-anchor="middle" class="text" style="font-size:11px;">r6=__sbss, r7=__ebss, r0=0, st.w r0,0[r6]; add 4,r6</text>
      <path class="arrow" d="M500 454 L500 514" />
      <rect x="340" y="520" width="300" height="28" class="box alt"/>
      <text x="500" y="534" text-anchor="middle" dominant-baseline="middle" class="text">Copy .data: for (dst=__sdata; dst<__edata; dst+=4) *dst = *src++</text>
      <text x="500" y="552" text-anchor="middle" class="text" style="font-size:11px;">r6=__sdata_rom(src), r7=__sdata(dst), r8=__edata, ld.w 0[r6],r9; st.w r9,0[r7]</text>
      <path class="arrow" d="M500 574 L500 634" />
      <rect x="340" y="660" width="300" height="28" class="box"/>
      <text x="500" y="674" text-anchor="middle" dominant-baseline="middle" class="text">(Optional) Verify data copy / checksum / protect registers</text>
      <path class="arrow" d="M500 696 L500 756" />
      <rect x="340" y="780" width="300" height="28" class="box alt"/>
      <text x="500" y="794" text-anchor="middle" dominant-baseline="middle" class="text">Call SystemInit()</text>
      <path class="arrow" d="M500 816 L500 876" />
      <rect x="340" y="880" width="300" height="28" class="box"/>
      <text x="500" y="894" text-anchor="middle" dominant-baseline="middle" class="text">Enable interrupts (ei)</text>
      <path class="arrow" d="M500 916 L500 976" />
      <rect x="340" y="980" width="300" height="28" class="box alt"/>
      <text x="500" y="994" text-anchor="middle" dominant-baseline="middle" class="text">Jump to main() (jmp [addr])</text>
      <path class="arrow" d="M500 1016 L500 1076" />
      <rect x="340" y="1080" width="300" height="28" class="box"/>
      <text x="500" y="1094" text-anchor="middle" dominant-baseline="middle" class="text">main() — アプリケーション開始</text>
      <text x="500" y="1112" text-anchor="middle" class="text" style="font-size:11px;">(GPIO 初期化 → ループ → LED toggle 等)</text>
    </g>
    <text x="500" y="1500" text-anchor="middle" class="text">注: 例外ベクタは `__exception_table` に配置。必要に応じてハンドラを割当ててください。</text>
  </svg>
  <p>`SystemInit()` の詳細フロー</p>
  <!-- inline SystemInit Detailed Flow SVG -->
  <svg xmlns="http://www.w3.org/2000/svg" width="900" height="1200" viewBox="0 0 900 1200" style="max-width:100%;border:1px solid #ddd;padding:8px;background:#fff;">
    <!-- inlined from diagrams/systeminit_flowchart.svg (compact boxes) -->
    <style>
      .box { fill: #fff; stroke:#ff7a59; stroke-width:1.6px; rx:6; }
      .alt { fill:#fff6f2; stroke:#ffae9a }
      .text { font-family: Arial, sans-serif; font-size:11px; fill:#07263c; }
      .title { font-size:15px; font-weight:700; fill:#c2410c; }
      .arrow { stroke:#ff7a59; stroke-width:1.6px; stroke-linecap:round; fill:none; marker-end: url(#arrow); }
    </style>
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
      </marker>
    </defs>
    <text x="450" y="26" text-anchor="middle" class="title">SystemInit Detailed Flow</text>
    <g transform="translate(40,60)">
      <rect x="270" y="10" width="300" height="28" class="box"/>
      <text x="450" y="24" text-anchor="middle" dominant-baseline="middle" class="text">SystemInit()</text>
      <path class="arrow" d="M450 44 L450 104" />
      <rect x="270" y="100" width="300" height="28" class="box alt"/>
      <text x="450" y="114" text-anchor="middle" dominant-baseline="middle" class="text">Enable MainOSC (MOSCE = 0x01)</text>
      <path class="arrow" d="M450 134 L450 194" />
      <rect x="270" y="200" width="300" height="28" class="box"/>
      <text x="450" y="214" text-anchor="middle" dominant-baseline="middle" class="text">Wait for MOSC stable (poll MOSCS.ACT)</text>
      <path class="arrow" d="M450 234 L450 294" />
      <rect x="270" y="310" width="300" height="28" class="box alt"/>
      <text x="450" y="324" text-anchor="middle" dominant-baseline="middle" class="text">Configure PLL (PLLC0) and enable</text>
      <text x="450" y="342" text-anchor="middle" class="text" style="font-size:11px;">Set multiplier/dividers as required</text>
      <path class="arrow" d="M450 356 L450 416" />
      <rect x="270" y="420" width="300" height="28" class="box"/>
      <text x="450" y="434" text-anchor="middle" dominant-baseline="middle" class="text">Wait for PLL stable (poll PLLS.ACT)</text>
      <path class="arrow" d="M450 454 L450 514" />
      <rect x="270" y="520" width="300" height="28" class="box alt"/>
      <text x="450" y="534" text-anchor="middle" dominant-baseline="middle" class="text">Configure clock dividers & selectors (CKSC registers)</text>
      <text x="450" y="552" text-anchor="middle" class="text" style="font-size:11px;">Set CPU / peripheral sources and wait for ACT</text>
      <path class="arrow" d="M450 574 L450 634" />
      <rect x="270" y="640" width="300" height="28" class="box"/>
      <text x="450" y="654" text-anchor="middle" dominant-baseline="middle" class="text">Optional: Disable/refresh Watchdog, Unlock protected regs</text>
      <path class="arrow" d="M450 674 L450 734" />
      <rect x="270" y="740" width="300" height="28" class="box alt"/>
      <text x="450" y="754" text-anchor="middle" dominant-baseline="middle" class="text">Initialize Interrupt controller (mask, set priority lowest)</text>
      <text x="450" y="772" text-anchor="middle" class="text" style="font-size:11px;">for i in 0..511: EIC[i] = masked, priority = 15</text>
      <path class="arrow" d="M450 788 L450 848" />
      <rect x="270" y="860" width="300" height="28" class="box"/>
      <text x="450" y="874" text-anchor="middle" dominant-baseline="middle" class="text">Update g_system_clock / g_peripheral_clock</text>
      <path class="arrow" d="M450 894 L450 954" />
      <rect x="270" y="960" width="300" height="28" class="box alt"/>
      <text x="450" y="974" text-anchor="middle" dominant-baseline="middle" class="text">Return to caller</text>
    </g>
  </svg>
  <h3>フェイル時の分岐</h3>
  <p>起動時／初期化時の代表的な失敗（MOSC未安定、PLLロック失敗、データ不一致、ウォッチドッグ）に対する分岐例を示します。</p>
  <!-- inline SystemInit with errors SVG -->
  <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1600" viewBox="0 0 1200 1600" style="max-width:100%;border:1px solid #ddd;padding:8px;background:#fff;">
    <!-- inlined from diagrams/systeminit_flowchart_with_errors.svg (compact boxes) -->
    <style>
      .box { fill: #fff; stroke: #0b3b75; stroke-width:2px; rx:6; }
      .alt { fill:#f7fbff; }
      .fail { fill:#fff5f5; stroke:#c92a2a; stroke-width:2px; }
      .text { font-family: Arial, Helvetica, sans-serif; font-size:12px; fill:#111; }
      .title { font-size:16px; font-weight:700; fill:#0b3b75; }
      .arrow { stroke:#333; stroke-width:2px; fill:none; marker-end: url(#arrowhead); }
    </style>
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
      </marker>
    </defs>
    <text x="600" y="36" text-anchor="middle" class="title">SystemInit Flow with Error Handling</text>
    <g transform="translate(40,70)">
      <rect x="450" y="10" width="300" height="28" class="box"/>
      <text x="600" y="40" text-anchor="middle" class="text">SystemInit()</text>
      <path class="arrow" d="M600 58 L600 110" />
      <rect x="450" y="110" width="300" height="28" class="alt"/>
      <text x="600" y="142" text-anchor="middle" class="text">Enable MainOSC (MOSCE=0x01)</text>
      <path class="arrow" d="M600 168 L600 220" />
      <rect x="450" y="220" width="300" height="28" class="box"/>
      <text x="370" y="252" text-anchor="middle" class="text">Wait MOSC stable (MOSCS.ACT)</text>
      <path class="arrow" d="M370 276 L370 320" />
      <rect x="450" y="320" width="300" height="28" class="alt"/>
      <text x="370" y="352" text-anchor="middle" class="text">MOSC OK → continue</text>
      <path class="arrow" d="M370 376 L600 376" />
      <rect x="620" y="320" width="300" height="28" class="fail"/>
      <text x="830" y="352" text-anchor="middle" class="text">MOSC FAIL → retry / fallback</text>
      <text x="830" y="370" text-anchor="middle" class="text" style="font-size:12px;">Try internal RC or retry N times</text>
      <path class="arrow" d="M830 384 L830 430" />
      <rect x="620" y="430" width="300" height="28" class="fail"/>
      <text x="830" y="462" text-anchor="middle" class="text">Fallback failed → enter Safe Mode / LED error</text>
      <path class="arrow" d="M830 498 L600 498" />
      <rect x="450" y="376" width="300" height="28" class="box alt"/>
      <text x="600" y="408" text-anchor="middle" class="text">Configure PLL (PLLC0) and enable</text>
      <path class="arrow" d="M600 440 L600 500" />
      <rect x="450" y="500" width="300" height="28" class="box"/>
      <text x="600" y="532" text-anchor="middle" class="text">Wait PLL stable (PLLS.ACT)</text>
      <path class="arrow" d="M600 556 L600 620" />
      <rect x="450" y="556" width="300" height="28" class="fail"/>
      <text x="290" y="588" text-anchor="middle" class="text">PLL FAIL → retry / reduce frequency</text>
      <text x="290" y="606" text-anchor="middle" class="text" style="font-size:12px;">If persistent, fallback to safe clock or halt</text>
      <path class="arrow" d="M290 620 L600 620" />
      <rect x="450" y="620" width="300" height="28" class="alt"/>
      <text x="600" y="652" text-anchor="middle" class="text">Configure clock dividers & selectors (CKSC registers)</text>
      <text x="600" y="672" text-anchor="middle" class="text" style="font-size:12px;">Set CPU / peripheral sources and wait for ACT</text>
      <path class="arrow" d="M600 696 L600 760" />
      <rect x="450" y="760" width="300" height="28" class="box"/>
      <text x="600" y="792" text-anchor="middle" class="text">Unlock protected regs / refresh WDOG if needed</text>
      <path class="arrow" d="M600 812 L600 860" />
      <rect x="450" y="860" width="300" height="28" class="alt"/>
      <text x="600" y="892" text-anchor="middle" class="text">Optional: Verify data copy / CRC check</text>
      <path class="arrow" d="M600 916 L600 960" />
      <rect x="450" y="960" width="300" height="28" class="box"/>
      <text x="450" y="992" text-anchor="middle" class="text">Verify OK → continue</text>
      <rect x="450" y="960" width="300" height="28" class="fail"/>
      <text x="600" y="992" text-anchor="middle" class="text">Verify FAIL → attempt restore / bootloader</text>
      <text x="600" y="1010" text-anchor="middle" class="text" style="font-size:12px;">Trigger bootloader update or fallback image</text>
      <path class="arrow" d="M450 1016 L600 1040" />
      <path class="arrow" d="M830 1036 L600 1060" />
      <rect x="450" y="1060" width="300" height="28" class="box alt"/>
      <text x="600" y="1092" text-anchor="middle" class="text">Initialize Interrupt controller (mask, set low priority)</text>
      <path class="arrow" d="M600 1116 L600 1180" />
      <rect x="450" y="1180" width="300" height="28" class="box"/>
      <text x="600" y="1212" text-anchor="middle" class="text">Update g_system_clock / g_peripheral_clock</text>
      <path class="arrow" d="M600 1236 L600 1280" />
      <rect x="450" y="1280" width="300" height="28" class="alt"/>
      <text x="600" y="1312" text-anchor="middle" class="text">Return to caller (cstartup)</text>
    </g>
    <text x="600" y="1560" text-anchor="middle" class="text">注: フェイル時の動作はプロジェクト要件に合わせて調整してください。</text>
  </svg>
  <h2>BSS と Data 初期化</h2>
  <p>BSS をワード単位で 0 埋め、データを ROM から RAM へワードコピーします。アライメントとセクションアドレスがリンカ設定と一致することを確認してください。</p>
  <h2>SystemInit の詳細</h2>
  <p>MainOSC の有効化、PLL の設定・待ち、クロック分周・切替、割り込みコントローラ初期化などを行います。`system_rh850.c` を参照してください。</p>
  <h2>ビルド手順（参考）</h2>
  <pre><code>rh850-elf-as -mcpu=g3m -o cstartup.o src/cstartup.asm
rh850-elf-gcc -mcpu=g3m -O2 -I inc -c src/system_rh850.c -o system_rh850.o
rh850-elf-gcc -mcpu=g3m -O2 -I inc -c src/main.c -o main.o
rh850-elf-ld -T linker_script.ld cstartup.o system_rh850.o main.o -o firmware.elf
rh850-elf-objcopy -O ihex firmware.elf firmware.hex</code></pre>
  <h2>検証・注意点</h2>
  <ul>
    <li>ベクタテーブルと各ハンドラは実装状況に合わせて拡張すること</li>
    <li>レジスタアドレスはサンプル値なので実機マニュアルと突合すること</li>
    <li>保護レジスタやウォッチドッグに注意して初期化手順を行うこと</li>
  </ul>
  <h2>変更履歴</h2>
  <ul>
    <li>2025-11-16: 初版作成</li>
  </ul>
</body>
</html>